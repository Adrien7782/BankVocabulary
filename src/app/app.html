@if (!isAuthenticated()) {
  <div class="auth-screen">
    <div class="auth-card">
      <h1>Connexion</h1>
      <p class="lede">Identifie-toi pour accéder à ta banque.</p>

      @if (auth.loading()) {
        <p class="muted">Chargement...</p>
      }

      <form (ngSubmit)="login()" class="auth-form" autocomplete="off">
        <label>
          Email
          <input
            type="email"
            name="email"
            [ngModel]="email()"
            (ngModelChange)="email.set($event)"
            required
            autocomplete="off"
            autocapitalize="none"
            spellcheck="false"
          />
        </label>
        <label>
          Mot de passe
          <input
            type="password"
            name="password"
            [ngModel]="password()"
            (ngModelChange)="password.set($event)"
            required
            autocomplete="off"
          />
        </label>
        <button type="submit">Se connecter</button>
      </form>

      @if (authError()) {
        <p class="auth-error">{{ authError() }}</p>
      }

      @if (auth.user() && !auth.user()?.emailVerified && environment.requireEmailVerification) {
        <div class="verify-block">
          <p>Vérifie ton email puis recharge la page.</p>
          <button type="button" (click)="sendVerification()" [disabled]="auth.verifying()">Renvoyer l'email</button>
        </div>
      }
    </div>
  </div>
} @else {
<div class="layout">
  <nav class="sidebar">
    <div class="brand">
      <span class="dot"></span>
      <div>
        <p class="eyebrow">Vocab</p>
        <strong>Bank</strong>
      </div>
      <div class="brand-avatar" *ngIf="isAuthenticated()">
        <div class="avatar" [style.background]="avatarColor()">{{ avatarInitial() }}</div>
      </div>
    </div>
    <button
      class="nav-btn"
      [class.active]="activeTab() === 'home'"
      (click)="switchTab('home')"
    >
      Accueil
    </button>
    <button
      class="nav-btn"
      [class.active]="activeTab() === 'bank'"
      (click)="switchTab('bank')"
    >
      Banque ({{ totalCards() }})
    </button>
    <button
      class="nav-btn"
      [class.active]="activeTab() === 'review'"
      (click)="switchTab('review')"
    >
      Révision
    </button>
    <div class="sidebar-meta">

      <button class="logout" type="button" (click)="logout()">Déconnexion</button>
    </div>
  </nav>

  <section class="page">
    <ng-container [ngSwitch]="activeTab()">
      <ng-container *ngSwitchCase="'home'">
        <header class="hero single">
          <div class="headline">
            <p class="eyebrow">Accueil</p>
            <h1>Dernières cartes & tests</h1>
            <p class="lede">Un coup d’œil rapide sur ce que tu viens d’ajouter et tes révisions.</p>
          </div>
        </header>

        <div class="home-sections">
          <section>
            <div class="section-title">
              <h2>Dernières cartes</h2>
              <span class="muted">8 plus récentes</span>
            </div>
            <div class="grid">
              @for (card of flashcards().slice(0, 8); track card.id) {
                <article class="card" role="presentation">
                  <div class="card-inner">
                    <div class="card-face front">
                      <div class="tag">Recto</div>
                      <p class="word">{{ card.front }}</p>
                    </div>
                    <div class="card-face back">
                      <div class="tag">Verso</div>
                      <p class="word">{{ card.back }}</p>
                    </div>
                  </div>
                </article>
              } @empty {
                <p class="empty">Aucune carte pour l’instant.</p>
              }
            </div>
          </section>

          <section>
            <div class="section-title">
              <h2>Historique des tests</h2>
              <span class="muted">Derniers tests</span>
            </div>
            <div class="history-grid with-toggle">
              @for (test of history().slice(0, showAllHistory ? 12 : 4); track test.id) {
                <article class="history-card" (click)="openHistoryTest(test)" tabindex="0" (keyup.enter)="openHistoryTest(test)">
                  <div class="history-header">
                    <span class="pill small">Test #{{ test.id }}</span>
                    <span class="muted">{{ test.size }} cartes</span>
                  </div>
                  <p class="score">{{ test.score }} / {{ test.size }}</p>
                  <p class="date">{{ test.createdAt | date:'short' }}</p>
                  <button class="link-btn" type="button">Voir le récap</button>
                </article>
              } @empty {
                <p class="empty">Pas encore de tests. Lance une session dans l’onglet Révision.</p>
              }
          </div>
            <!-- <div class="grid recap-grid">
              @for (test of history().slice(0,4); track test.id) {
                <article
                  class="card recap"
                  [ngClass]="{
                    correct: test.score === test.size,
                    wrong: test.score !== test.size
                  }"
                  [class.flipped]="false"
                  (click)="openHistoryTest(test)"
                  tabindex="0"
                  (keyup.enter)="openHistoryTest(test)"
                >
                  <div class="card-inner">
                    <div class="card-face front">
                      <div class="tag">Test #{{ test.id }}</div>
                      <p class="word">Score : {{ test.score }} / {{ test.size }}</p>
                    </div>
                    <div class="card-face back">
                      <div class="tag">Réponses</div>
                      <p class="word">Clique pour voir le récap complet</p>
                    </div>
                  </div>
                </article>
              } @empty {
                <p class="empty">Pas encore de tests. Lance une session dans l’onglet Révision.</p>
              }
            </div> -->
          </section>
        </div>
      </ng-container>

      <ng-container *ngSwitchCase="'bank'">
        <header class="hero">
          <div class="headline">
            <p class="eyebrow">Banque de cartes</p>
            <h1>Flashcards</h1>
            <p class="lede">Ajoute des mots, évènements, question... , clique sur une carte pour révéler la réponse.</p>
            <div class="stats">
              <span class="dot"></span>
              <span>{{ totalCards() }} carte{{ totalCards() > 1 ? 's' : '' }}</span>
            </div>
            <div class="actions-bar">
              <button
                type="button"
                class="shuffle-btn"
                (click)="shuffleCards()"
                [disabled]="flashcards().length === 0"
              >
                Mélanger
              </button>
              <button
                type="button"
                class="shuffle-btn"
                (click)="flipAllCards()"
                [disabled]="flashcards().length === 0"
              >
                Tout retourner
              </button>
              <button
                type="button"
                class="delete-toggle"
                [class.active]="deleteMode()"
                (click)="toggleDeleteMode()"
              >
                {{ deleteMode() ? 'Terminer suppression' : 'Supprimer cartes' }}
              </button>
            </div>
          </div>

          <form class="new-card" (ngSubmit)="addCard()" #cardForm="ngForm" autocomplete="off">
            <label>
              recto
              <input
                name="front"
                type="text"
                [(ngModel)]="form.front"
                required
                autocomplete="off"
                autocapitalize="none"
                spellcheck="false"
              />
            </label>
            <label>
              verso
              <input
                name="back"
                type="text"
                [(ngModel)]="form.back"
                required
                autocomplete="off"
                autocapitalize="none"
                spellcheck="false"
              />
            </label>
            <button type="submit" [disabled]="cardForm.form.invalid">Ajouter à la banque</button>
          </form>
        </header>

        <section
          class="grid"
          aria-label="Liste des flashcards"
          [class.delete-mode]="deleteMode()"
          [class.shuffling]="shuffleWave()"
        >
          @if (flashcards().length === 0) {
            <p class="empty">Ajoute ton premier mot pour créer ta collection.</p>
          } @else {
            @for (card of flashcards(); track card.id) {
              <article
                class="card"
                #cardEl
                [class.new-card]="card.id === lastAddedId()"
                (click)="toggleCard(card.id)"
                [class.flipped]="card.flipped"
                role="button"
                [attr.aria-pressed]="card.flipped"
                tabindex="0"
                (keyup.enter)="toggleCard(card.id)"
              >
                @if (deleteMode()) {
                  <button
                    class="delete-badge"
                    type="button"
                    (click)="deleteCard(card.id); $event.stopPropagation()"
                    aria-label="Supprimer cette carte"
                  >
                    &times;
                  </button>
                }
                <div class="card-inner">
                 <div class="card-face front">
                    <div class="tag">Recto</div>
                    <p class="word" [style.font-size]="fontSize(card.front)">{{ card.front }}</p>
                  </div>
                  <div class="card-face back">
                    <div class="tag">Verso</div>
                    <p class="word" [style.font-size]="fontSize(card.back)">{{ card.back }}</p>
                  </div>
                </div>
              </article>
            }
          }
        </section>
      </ng-container>

      <ng-container *ngSwitchCase="'review'">
        <section class="hero">
          <div class="headline">
            <p class="eyebrow">Session de révision</p>
            <h1>Teste-toi</h1>
            <p class="lede">Choisis le nombre de cartes, réponds, puis valide pour voir la solution.</p>
            <div class="stats">
              <span class="dot"></span>
              <span>Score : {{ score() }} / {{ reviewCards().length || testSize() }}</span>
            </div>
          </div>

          <form class="new-card" (ngSubmit)="startTest()" autocomplete="off">
            <label>
              Nombre de cartes
              <input
                name="size"
                type="number"
                min="1"
                [max]="totalCards() || 1"
                [ngModel]="testSize()"
                (ngModelChange)="testSize.set(+($event || 0))"
                placeholder="5"
                required
                autocomplete="off"
                inputmode="numeric"
              />
            </label>
            <button type="submit">Nouveau test</button>
          </form>
        </section>

        @if (reviewCards().length === 0 && !testFinished()) {
          <p class="empty">Lance un test pour t'entraîner.</p>
          @if (history().length > 0) {
            <div class="history-grid with-toggle">
              @for (test of history().slice(0, showAllHistory ? 12 : 4); track test.id) {
                <article class="history-card" (click)="openHistoryTest(test)" tabindex="0" (keyup.enter)="openHistoryTest(test)">
                  <div class="history-header">
                    <span class="pill small">Test #{{ test.id }}</span>
                    <span class="muted">{{ test.size }} cartes</span>
                  </div>
                  <p class="score">{{ test.score }} / {{ test.size }}</p>
                  <p class="date">{{ test.createdAt | date:'short' }}</p>
                  <button class="link-btn" type="button">Voir le récap</button>
                </article>
              }
              @if (history().length > 4) {
                <div class="more-btn-wrapper">
                  <button class="nav-btn more-btn" type="button" (click)="showAllHistory = !showAllHistory">
                    {{ showAllHistory ? '▴' : '▾' }}
                  </button>
                </div>
              }
            </div>
          }
        }

        @if (testFinished() && reviewCards().length > 0 && !selectedHistory()) {
          <div class="result">
            <p>Score : {{ score() }} / {{ reviewCards().length }}</p>
            <button class="nav-btn" (click)="startTest()">Relancer</button>
            <div class="grid recap-grid">
            @for (card of reviewCards().slice(0, showAllRecap ? reviewCards().length : 8); track card.id) {
              <article
                class="card recap"
                [ngClass]="{
                  correct: answers()[card.id] === true,
                    wrong: answers()[card.id] === false
                  }"
                  [class.flipped]="recapFlips()[card.id]"
                  (click)="toggleRecapCard(card.id)"
                >
                  <div class="card-inner">
                    <div class="card-face front">
                      <div class="tag">Question</div>
                      <p class="word" [style.font-size]="fontSize(card.front)">{{ card.front }}</p>
                    </div>
                    <div class="card-face back">
                      <div class="tag">Réponse</div>
                      <p class="word" [style.font-size]="fontSize(card.back)">{{ card.back }}</p>
                    </div>
                  </div>
                </article>
              }
            </div>
            @if (reviewCards().length > 8) {
              <div class="more-btn-wrapper">
                <button class="nav-btn more-btn" type="button" (click)="showAllRecap = !showAllRecap">
                  {{ showAllRecap ? '▴' : '▾' }}
                </button>
              </div>
            }
          </div>
          <div class="history-grid with-toggle">
              @for (test of history().slice(0, showAllHistory ? 12 : 4); track test.id) {
                <article class="history-card" (click)="openHistoryTest(test)" tabindex="0" (keyup.enter)="openHistoryTest(test)">
                  <div class="history-header">
                    <span class="pill small">Test #{{ test.id }}</span>
                    <span class="muted">{{ test.size }} cartes</span>
                  </div>
                  <p class="score">{{ test.score }} / {{ test.size }}</p>
                  <p class="date">{{ test.createdAt | date:'short' }}</p>
                  <button class="link-btn" type="button">Voir le récap</button>
                </article>
              } @empty {
                <p class="empty">Pas encore de tests. Lance une session dans l’onglet Révision.</p>
              }
              @if (history().length > 4) {
                <div class="more-btn-wrapper">
                  <button class="nav-btn more-btn" type="button" (click)="showAllHistory = !showAllHistory">
                    {{ showAllHistory ? '▴' : '▾' }}
                  </button>
                </div>
              }
          </div>
          
        }

        @if (selectedHistory(); as recap) {
          <div class="result">
            <p>Récap test #{{ recap.id }} — {{ recap.score }} / {{ recap.size }}</p>
            <p>Score : {{ recap.score }} / {{ recap.size }}</p>
            <button class="nav-btn" (click)="startTest(recap.cards)">Relancer ce test</button>

                        <div class="grid recap-grid">
            @for (card of reviewCards().slice(0, showAllRecap ? reviewCards().length : 8); track card.id) {
              <article
                class="card recap"
                [ngClass]="{
                  correct: answers()[card.id] === true,
                    wrong: answers()[card.id] === false
                  }"
                  [class.flipped]="recapFlips()[card.id]"
                  (click)="toggleRecapCard(card.id)"
                >
                  <div class="card-inner">
                    <div class="card-face front">
                      <div class="tag">Question</div>
                      <p class="word" [style.font-size]="fontSize(card.front)">{{ card.front }}</p>
                    </div>
                    <div class="card-face back">
                      <div class="tag">Réponse</div>
                      <p class="word" [style.font-size]="fontSize(card.back)">{{ card.back }}</p>
                    </div>
                  </div>
                </article>
              }
            </div>
          </div>
        }

        @if (!selectedHistory() && !testFinished() && currentCard(); as card) {
          <div class="review-card" [class.revealed]="cardRevealed()">
            <div class="card-inner">
              <div class="card-face front">
                <div class="tag">Carte {{ currentIndex() + 1 }}</div>
                <p
                  class="word"
                  [style.font-size]="fontSize(showFront() ? card.front : card.back)"
                >
                  {{ showFront() ? card.front : card.back }}
                </p>
              </div>
              <div class="card-face back">
                <div class="tag">Réponse attendue</div>
                <p
                  class="word"
                  [style.font-size]="fontSize(showFront() ? card.back : card.front)"
                >
                  {{ showFront() ? card.back : card.front }}
                </p>
                @if (cardRevealed()) {
                  <p class="hint">
                    {{ lastCorrect() ? 'Bonne réponse !' : 'Raté' }}
                  </p>
                }
              </div>
            </div>
          </div>

          <form class="answer" (ngSubmit)="submitAnswer()" autocomplete="off" *ngIf="!testFinished()">
            <div class="answer-header">
              <div>
                <p class="answer-title">Ta réponse</p>
                <p class="answer-sub">Tape la traduction puis valide.</p>
              </div>
              <div class="chip" [class.success]="lastCorrect()" [class.error]="lastCorrect() === false">
                @if (lastCorrect() === null) { En attente }
                @else if (lastCorrect()) { Correct }
                @else { Incorrect }
              </div>
            </div>

            <input
              class="answer-input"
              name="answer"
              type="text"
              placeholder="Écris ta réponse"
              [disabled]="cardRevealed()"
              [value]="answer()"
              (input)="answer.set($any($event.target).value)"
              required
              autocomplete="off"
              autocapitalize="none"
              spellcheck="false"
            />

            <div class="actions">
              <button class="primary" type="submit" [disabled]="cardRevealed()">Valider</button>
              <button class="secondary" type="button" [disabled]="!cardRevealed()" (click)="nextCard()">
                Carte suivante
              </button>
            </div>
          </form>
        }
      </ng-container>
    </ng-container>
  </section>
</div>
}
